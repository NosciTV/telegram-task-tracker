
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á</title>
    <meta name="viewport" content=device-width, initial-scale=1.0>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .task-row { background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .add-btn { position: fixed; top: 20px; right: 20px; z-index: 10; }
        #taskForm { display: none; }
    </style>
</head>
<body>
<div class="container py-4">
    <h4 class="mb-3">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h4>
    <button class="btn btn-success add-btn" onclick="toggleForm()">Ôºã</button>

    <div class="mb-3">
        <label for="filter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
        <select id="filter" class="form-select" onchange="loadTasks()">
            <option value="–≤—Å–µ">–í—Å–µ</option>
            <option value="–≤ —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–≥–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
            <option value="—Ö–æ–ª–¥">–•–æ–ª–¥</option>
        </select>
    </div>

    <div id="taskForm" class="mb-4">
        <input id="title" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
        <textarea id="description" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <select id="status" class="form-select">
            <option value="–≤ —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–≥–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
            <option value="—Ö–æ–ª–¥">–•–æ–ª–¥</option>
        </select>
        <input id="deadline" class="form-control" type="date">
        <input id="editId" type="hidden">
        <button class="btn btn-primary w-100 mt-2" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div id="taskList"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const userId = tg.initDataUnsafe.user.id;
    const API = "https://task-tracker-backend-40ra.onrender.com";

    let currentTasks = [];

    function toggleForm(task = null) {
        const form = document.getElementById("taskForm");
        const editing = task !== null;
        form.style.display = "block";

        document.getElementById("title").value = editing ? task.title : "";
        document.getElementById("description").value = editing ? task.description : "";
        document.getElementById("status").value = editing ? task.status : "–≤ —Ä–∞–±–æ—Ç–µ";
        document.getElementById("deadline").value = editing ? task.deadline : "";
        document.getElementById("editId").value = editing ? task.id : "";
    }

    async function loadTasks() {
        const filter = document.getElementById("filter").value;
        const res = await fetch(`${API}/tasks/${userId}`);
        const data = await res.json();
        currentTasks = data;
        const taskList = document.getElementById("taskList");
        taskList.innerHTML = "";

        data.filter(t => filter === "–≤—Å–µ" || t.status === filter).forEach(task => {
            const row = document.createElement("div");
            row.className = "task-row row align-items-center";
            row.innerHTML = `
                <div class="col-3"><strong>${task.title}</strong></div>
                <div class="col-3">${task.status}</div>
                <div class="col-3">${task.deadline || "-"}</div>
                <div class="col-3 text-end">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick='editTask(${task.id})'>‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-outline-danger" onclick='deleteTask(${task.id})'>üóë</button>
                </div>
            `;
            taskList.appendChild(row);
        });
    }

    function editTask(id) {
        const task = currentTasks.find(t => t.id === id);
        if (task) toggleForm(task);
    }

    async function saveTask() {
        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const status = document.getElementById("status").value;
        const deadline = document.getElementById("deadline").value;
        const taskId = document.getElementById("editId").value;

        const taskData = { user_id: userId, title, description, status, deadline };

        if (taskId) {
            await fetch(`${API}/tasks/${taskId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(taskData)
            });
        } else {
            await fetch(`${API}/tasks`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(taskData)
            });
        }

        document.getElementById("taskForm").style.display = "none";
        document.getElementById("editId").value = "";
        loadTasks();
    }

    async function deleteTask(id) {
        await fetch(`${API}/tasks/${id}?user_id=${userId}`, { method: "DELETE" });
        loadTasks();
    }

    loadTasks();
</script>
</body>
</html>
